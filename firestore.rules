rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is an admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Grow App Rules ---

    match /spaces/{spaceId} {
      // Allow read if: member OR space is public (for browsing joinable spaces)
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.memberUids ||
        resource.data.isPublic == true
      );
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      // Allow update if: member OR joining a public space (adding self to memberUids)
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.memberUids ||
        (resource.data.isPublic == true &&
         request.auth.uid in request.resource.data.memberUids &&
         request.resource.data.memberUids.hasAll(resource.data.memberUids))
      );
      // Support both ownerId and createdBy (legacy) for deletion
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.createdBy == request.auth.uid
      );
    }

    match /habits/{habitId} {
      // Allow read if:
      // 1. Personal space: user must be the creator
      // 2. User is assigned to the habit
      // 3. User is a member of the non-personal space
      allow read: if isAuthenticated() && (
        (resource.data.spaceId == 'personal' && resource.data.createdBy == request.auth.uid) ||
        resource.data.createdBy == request.auth.uid ||
        (resource.data.assigneeIds != null && request.auth.uid in resource.data.assigneeIds) ||
        (resource.data.spaceId != 'personal' &&
         exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Create: user must be creator, and for non-personal space, must be a member
      allow create: if isAuthenticated() &&
        request.resource.data.createdBy == request.auth.uid && (
          request.resource.data.spaceId == 'personal' ||
          (exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
           request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids)
        );

      // Update/delete: creator or space member
      allow update, delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        (resource.data.spaceId != 'personal' &&
         exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );
    }

    match /quests/{questId} {
      allow read, update: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids;

      allow create: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids;
    }

    match /completions/{completionId} {
      // Allow read if:
      // 1. Personal space: user must be the completion owner
      // 2. User owns the completion
      // 3. User is a member of the non-personal space
      allow read: if isAuthenticated() && (
        (resource.data.spaceId == 'personal' && resource.data.userId == request.auth.uid) ||
        resource.data.userId == request.auth.uid ||
        (resource.data.spaceId != 'personal' &&
         exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Update/delete: owner or space member
      allow update, delete: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.spaceId != 'personal' &&
         exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Create:
      // 1. Personal space: user must be the userId
      // 2. Non-personal space: user must be a member of the space (can complete for self or other members like children)
      allow create: if isAuthenticated() && (
        // Personal space: must be completing for yourself
        (request.resource.data.spaceId == 'personal' && request.resource.data.userId == request.auth.uid) ||
        // Non-personal space: must be a member of the space
        (request.resource.data.spaceId != 'personal' &&
         exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids)
      );
    }
    
    match /learning_goals/{goalId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /learning_sessions/{sessionId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
      allow create: if isAuthenticated(); // Anyone can send, logic checks recipient
      allow update: if isAuthenticated() && resource.data.recipientId == request.auth.uid; // Mark read
    }

    // --- Habit Reminders ---
    match /habitReminders/{reminderId} {
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    match /userReminderPreferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Habits Preferences (hints, UI state) ---
    match /habits_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Space Invitations ---
    match /spaceInvitations/{invitationId} {
      // Allow reading invitations if user is inviter, invitee, or space member
      allow read: if isAuthenticated() && (
        resource.data.invitedBy == request.auth.uid ||
        resource.data.inviteeUid == request.auth.uid ||
        (resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow creating invitations if user is a member of the space
      allow create: if isAuthenticated() && (
        request.resource.data.invitedBy == request.auth.uid &&
        request.resource.data.spaceId != null &&
        exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids
      );

      // Allow updating (accept/decline) if user is invitee or inviter
      allow update: if isAuthenticated() && (
        resource.data.inviteeUid == request.auth.uid ||
        resource.data.invitedBy == request.auth.uid
      );

      // Allow deleting if user is inviter or a member of the space
      allow delete: if isAuthenticated() && (
        resource.data.invitedBy == request.auth.uid ||
        (resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );
    }


    // --- Fit App Rules ---

    match /fit_spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
    }

    match /workouts/{workoutId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)).data.memberUids)
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/fit_spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/fit_spaces/$(request.resource.data.spaceId)).data.memberUids)
      );
        
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }

    match /challenges/{challengeId} {
      allow read, create, update: if isAuthenticated() &&
        exists(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)).data.memberUids;
    }

    // --- Fit App: Nutrition ---
    match /meals/{mealId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /custom_foods/{foodId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /nutrition_goals/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Fit App: Recipes ---
    match /recipes/{recipeId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    // --- Fit App: Supplements ---
    match /supplements/{supplementId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /supplement_logs/{logId} {
      allow read, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }


    // --- Todo (Tasks) App Rules ---

    match /todo_spaces/{spaceId} {
      // Allow reading a specific space if user is a member
      allow get: if isAuthenticated() && request.auth.uid in resource.data.memberUids;

      // Allow listing/querying spaces where user is a member
      allow list: if isAuthenticated() && request.auth.uid in resource.data.memberUids;

      // Allow creating a space if user includes themselves in memberUids
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;

      // Allow updating a space if user is a member
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;

      // Allow deleting a space if user is the creator
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /tasks/{taskId} {
      // Allow read if user is owner OR assigned OR in the space
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.assigneeIds != null && request.auth.uid in resource.data.assigneeIds) ||
        (resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow create if user is owner (legacy) OR in the space
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/todo_spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(request.resource.data.spaceId)).data.memberUids)
      );

      // Allow update if user is owner OR assigned OR in the space
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.assigneeIds ||
        (exists(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow delete if user is owner OR in the space
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)).data.memberUids)
      );
    }

    // --- Journey App Rules ---

    match /journal_entries/{entryId} {
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    match /journalSpaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /user_settings/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /journal_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /todo_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // User-nested settings (for apps like Pulse)
    match /users/{userId}/user_settings/{settingId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // User notifications (space invites, etc.)
    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /prompt_library/{promptId} {
      allow read: if isAuthenticated();
    }

    match /personalized_prompts/{promptId} {
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /prompt_responses/{responseId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /daily_prompts/{promptId} {
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sentiment_analysis/{entryId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sentiment_insights/{insightId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sentiment_metrics/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Health App Rules ---

    match /healthSpaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /health_metrics/{metricId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    // --- Pulse App Rules ---
    match /clocks/{clockId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /pulse_spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // --- Workflow App Rules ---
    match /workflows/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Activity Rules ---
    match /activities/{activityId} {
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // --- Moments App Rules ---

    match /moments_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /moments_spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    match /moments/{momentId} {
      // Allow read if user is owner OR in the space
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/moments_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/moments_spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow create if user is owner (will be set) OR in the space
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        (request.resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/moments_spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/moments_spaces/$(request.resource.data.spaceId)).data.memberUids)
      );

      // Allow update/delete only by owner
      allow update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // --- Apps Configuration (Admin) ---
    match /apps/{appId} {
      allow read: if true; // Public read for theming
      allow write: if isAdmin(); // Only admin can write
    }

    // --- Global Settings (Admin) ---
    match /settings/{settingId} {
      allow read: if true; // Public read for theming
      allow write: if isAdmin(); // Only admin can write
    }

    // --- Spaces Configuration (Admin-managed, user-readable) ---
    match /config/{configId} {
      allow read: if isAuthenticated(); // All authenticated users can read config
      allow write: if isAdmin(); // Only admins can modify config
    }

    // --- Backgrounds (Admin-managed, user-readable) ---
    match /backgrounds/{backgroundId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Covers (Admin-managed, user-readable) ---
    match /covers/{coverId} {
      allow read: if true; // All users can read covers for journal cards
      allow write: if isAdmin(); // Only admin can write
    }

    // --- Video Backgrounds (Admin-managed, user-readable) ---
    match /video-backgrounds/{videoId} {
      allow read: if true; // All users can read for landing pages
      allow write: if isAdmin(); // Only admin can write
    }

    // --- System Updates (Admin) ---
    match /system_updates/{updateId} {
      allow read: if true; // Public read for update banners
      allow write: if isAdmin(); // Only admin can write
    }

    // --- Track App Rules ---
    match /users/{userId}/subscriptions/{subscriptionId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /track_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Notes App Rules ---
    match /noteSpaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /users/{userId}/notes/{noteId} {
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read, update: if isAuthenticated() && (
        request.auth.uid == userId ||
        (resource.data.sharedWithUserIds is list && request.auth.uid in resource.data.sharedWithUserIds)
      );
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    match /users/{userId}/labels/{labelId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/reminders/{reminderId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/preferences/{preferenceId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/filterPresets/{presetId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/health_preferences/{settingId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /feedback/{feedbackId} {
      allow create: if isAuthenticated();
      // Allow public access for admin dashboard (admin role checked client-side)
      allow read, update, delete: if true;
    }


    // --- Calendar App Rules ---
    // Rules for calendar event access (nested under users)
    match /users/{userId}/calendar_events/{eventId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Root-level calendar events (used by display app)
    match /calendar_events/{eventId} {
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // --- Projects App Rules ---
    match /whiteboards/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Stripe / Subscriptions ---
    match /subscriptions/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin(); // Only server-side/admin can write subscription data
    }

    match /webhook_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false; // Only server-side can write (Admin SDK bypasses rules)
    }

    // --- General / Legacy ---
    // Auth check restored
    match /users/{userId} {
      allow read, write: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }
  }
}