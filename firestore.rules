rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is an admin
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Grow App Rules ---

    match /spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /habits/{habitId} {
      // Allow read if user is in space OR is assigned to the habit
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.assigneeIds ||
        (exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Create: member of space + must set createdBy to their own uid
      allow create: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids &&
        request.resource.data.createdBy == request.auth.uid;

      allow update, delete: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids;
    }

    match /quests/{questId} {
      allow read, update: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids;

      allow create: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids;
    }

    match /completions/{completionId} {
      // Allow read if user created the completion OR is in the space
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids)
      );

      allow update, delete: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(resource.data.spaceId)).data.memberUids;

      allow create: if isAuthenticated() &&
        exists(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/spaces/$(request.resource.data.spaceId)).data.memberUids;
    }
    
    match /learning_goals/{goalId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /learning_sessions/{sessionId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
      allow create: if isAuthenticated(); // Anyone can send, logic checks recipient
      allow update: if isAuthenticated() && resource.data.recipientId == request.auth.uid; // Mark read
    }


    // --- Fit App Rules ---

    match /fit_spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
    }

    match /workouts/{workoutId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)).data.memberUids)
      );
      
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/fit_spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/fit_spaces/$(request.resource.data.spaceId)).data.memberUids)
      );
        
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }

    match /challenges/{challengeId} {
      allow read, create, update: if isAuthenticated() && 
        exists(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)) &&
        request.auth.uid in get(/databases/$(database)/documents/fit_spaces/$(resource.data.spaceId)).data.memberUids;
    }


    // --- Todo (Tasks) App Rules ---

    match /todo_spaces/{spaceId} {
      // Allow reading a specific space if user is a member
      allow get: if isAuthenticated() && request.auth.uid in resource.data.memberUids;

      // Allow listing/querying spaces where user is a member
      allow list: if isAuthenticated() && request.auth.uid in resource.data.memberUids;

      // Allow creating a space if user includes themselves in memberUids
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;

      // Allow updating a space if user is a member
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;

      // Allow deleting a space if user is the creator
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /tasks/{taskId} {
      // Allow read if user is owner OR assigned OR in the space
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.assigneeIds != null && request.auth.uid in resource.data.assigneeIds) ||
        (resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow create if user is owner (legacy) OR in the space
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/todo_spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(request.resource.data.spaceId)).data.memberUids)
      );

      // Allow update if user is owner OR assigned OR in the space
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid in resource.data.assigneeIds ||
        (exists(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow delete if user is owner OR in the space
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (exists(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/todo_spaces/$(resource.data.spaceId)).data.memberUids)
      );
    }

    // --- Journey App Rules ---

    match /journal_entries/{entryId} {
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    match /journalSpaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /user_settings/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /journal_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // User-nested settings (for apps like Pulse)
    match /users/{userId}/user_settings/{settingId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /prompt_library/{promptId} {
      allow read: if isAuthenticated();
    }

    match /personalized_prompts/{promptId} {
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /prompt_responses/{responseId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /daily_prompts/{promptId} {
       allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
       allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sentiment_analysis/{entryId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sentiment_insights/{insightId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read, update: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /sentiment_metrics/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Health App Rules ---

    match /healthSpaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /health_metrics/{metricId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    // --- Pulse App Rules ---
    match /clocks/{clockId} {
      allow read, update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    match /pulse_spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    // --- Workflow App Rules ---
    match /workflows/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Activity Rules ---
    match /activities/{activityId} {
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // --- Moments App Rules ---

    match /moments_spaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    match /moments/{momentId} {
      // Allow read if user is owner OR in the space
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/moments_spaces/$(resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/moments_spaces/$(resource.data.spaceId)).data.memberUids)
      );

      // Allow create if user is owner (will be set) OR in the space
      allow create: if isAuthenticated() && (
        request.resource.data.ownerId == request.auth.uid ||
        (request.resource.data.spaceId != null &&
         exists(/databases/$(database)/documents/moments_spaces/$(request.resource.data.spaceId)) &&
         request.auth.uid in get(/databases/$(database)/documents/moments_spaces/$(request.resource.data.spaceId)).data.memberUids)
      );

      // Allow update/delete only by owner
      allow update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }

    // --- Apps Configuration (Admin) ---
    match /apps/{appId} {
      allow read: if true; // Public read for theming
      allow write: if true; // Admin app restricts access client-side
    }

    // --- Global Settings (Admin) ---
    match /settings/{settingId} {
      allow read: if true; // Public read for theming
      allow write: if true; // Admin app restricts access client-side
    }

    // --- Spaces Configuration (Admin-managed, user-readable) ---
    match /config/{configId} {
      allow read: if isAuthenticated(); // All authenticated users can read config
      allow write: if isAdmin(); // Only admins can modify config
    }

    // --- Backgrounds (Admin-managed, user-readable) ---
    // TODO: Re-add auth check after debugging
    match /backgrounds/{backgroundId} {
      allow read, write: if true;
    }

    // --- Covers (Admin-managed, user-readable) ---
    match /covers/{coverId} {
      allow read: if true; // All users can read covers for journal cards
      allow write: if true; // Admin app restricts access client-side
    }

    // --- Video Backgrounds (Admin-managed, user-readable) ---
    match /video-backgrounds/{videoId} {
      allow read: if true; // All users can read for landing pages
      allow write: if true; // Admin app restricts access client-side
    }

    // --- System Updates (Admin) ---
    match /system_updates/{updateId} {
      allow read: if true; // Public read for update banners
      allow write: if true; // Admin app restricts access client-side
    }

    // --- Notes App Rules ---
    match /noteSpaces/{spaceId} {
      allow read: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.memberUids;
      allow update: if isAuthenticated() && request.auth.uid in resource.data.memberUids;
      allow delete: if isAuthenticated() && resource.data.createdBy == request.auth.uid;
    }

    match /users/{userId}/notes/{noteId} {
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow read, update: if isAuthenticated() && (
        request.auth.uid == userId ||
        (resource.data.sharedWithUserIds is list && request.auth.uid in resource.data.sharedWithUserIds)
      );
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }
    
    match /users/{userId}/labels/{labelId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/reminders/{reminderId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/preferences/{preferenceId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/filterPresets/{presetId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /users/{userId}/health_preferences/{settingId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    match /feedback/{feedbackId} {
      allow create: if isAuthenticated();
      // Allow public read for admin dashboard (admin role checked client-side)
      allow read: if true;
      allow update, delete: if isAuthenticated();
    }


    // --- Calendar App Rules ---
    // Rules for calendar event access (nested under users)
    match /users/{userId}/calendar_events/{eventId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Root-level calendar events (used by display app)
    match /calendar_events/{eventId} {
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // --- Projects App Rules ---
    match /whiteboards/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Stripe / Subscriptions ---
    match /subscriptions/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAdmin(); // Only server-side/admin can write subscription data
    }

    match /webhook_events/{eventId} {
      allow read: if isAdmin();
      allow write: if false; // Only server-side can write (Admin SDK bypasses rules)
    }

    // --- General / Legacy ---
    // NOTE: Auth check temporarily removed due to race condition with Firestore init
    // TODO: Fix auth propagation and restore: if isAuthenticated() && (request.auth.uid == userId || isAdmin())
    match /users/{userId} {
      allow read, write: if true;
    }
  }
}
